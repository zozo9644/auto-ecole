<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Admin - Auto Ã‰cole Ben Cheikh</title>

<!-- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© -->
<script>
if (localStorage.getItem("admin_logged") !== "yes") {
    window.location.href = "admin-login.html";
}
</script>

<style>
/* ====== GENERAL ====== */
body {
    font-family: "Cairo", Arial, sans-serif;
    direction: rtl;
    background: #eef2f7;
    margin: 0;
    padding: 0;
    color: #333;
}

header {
    background: linear-gradient(135deg, #0056d6, #003b9e);
    color: white;
    padding: 35px 20px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
header h1 {
    margin: 0;
    font-size: 34px;
}
header p {
    margin: 5px 0 0;
    font-size: 18px;
    opacity: 0.9;
}

/* ====== NAVIGATION ====== */
nav {
    text-align: center;
    margin: 18px 0;
}
nav a, nav button {
    margin: 0 8px;
    text-decoration: none;
    color: #004aad;
    font-weight: bold;
    padding: 10px 22px;
    border: 2px solid #004aad;
    border-radius: 10px;
    transition: 0.3s;
    background: white;
    cursor: pointer;
    font-size: 16px;
}
nav a:hover, nav button:hover {
    background: #004aad;
    color: white;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

/* ====== MAIN BOX ====== */
section {
    padding: 25px;
    max-width: 950px;
    margin: auto;
    background: white;
    border-radius: 14px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
}
h2 {
    text-align: center;
    color: #004aad;
    font-size: 28px;
    margin-bottom: 10px;
}

/* ====== FORMS ====== */
form, .edit-form {
    display: flex;
    flex-direction: column;
    gap: 14px;
    margin-top: 20px;
}

input, select, button {
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #c9c9c9;
}
input:focus, select:focus {
    outline: none;
    border-color: #004aad;
    box-shadow: 0 0 5px rgba(0,74,173,0.4);
}
button {
    background: #004aad;
    color: white;
    cursor: pointer;
    border: none;
    transition: 0.3s;
    font-size: 17px;
}
button:hover {
    background: #003080;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* ====== TABLE ====== */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 18px;
    background: #ffffff;
    border-radius: 10px;
    overflow: hidden;
}
th {
    background: #004aad;
    color: white;
}
th, td {
    border: 1px solid #ddd;
    padding: 12px;
    font-size: 15px;
}

/* ====== EDIT BOX ====== */
.edit-form {
    display: none;
    background: #f4f7fb;
    padding: 18px;
    border-radius: 12px;
    margin-top: 25px;
    border: 1px solid #cfd7e3;
}
.edit-form h3 {
    margin: 0 0 10px;
    color: #004aad;
}

/* ====== POPUP ====== */
.popup {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(4px);
}
.popup-content {
    background: white;
    color: #000;
    padding: 25px;
    width: 90%;
    max-width: 530px;
    border-radius: 14px;
    max-height: 80%;
    overflow-y: auto;
    box-shadow: 0 8px 18px rgba(0,0,0,0.25);
}
.popup-content h3 {
    margin-top: 0;
    color: #004aad;
    font-size: 24px;
    text-align: center;
}
.close-btn {
    background: #cc0000;
    color: white;
    padding: 10px 18px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    width: 100%;
    font-size: 17px;
    margin-top: 20px;
}
.close-btn:hover {
    background: #990000;
}

/* ====== FOOTER ====== */
footer {
    text-align: center;
    padding: 18px;
    margin-top: 25px;
    color: #555;
    font-size: 14px;
}
</style>
</head>

<body>

<header>
  <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Admin</h1>
  <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ±Ø´Ø­ÙŠÙ† ÙˆØ§Ù„Ø¯Ø±ÙˆØ³</p>
</header>

<nav>
  <a href="index.html">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
  <button onclick="logout()">Ø®Ø±ÙˆØ¬</button>
</nav>

<section>
  <h2>Ø¥Ø¶Ø§ÙØ© Ù…ØªØ±Ø´Ø­ Ø¬Ø¯ÙŠØ¯</h2>

  <form id="candidateForm">
    <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
    <input type="number" id="age" placeholder="Ø§Ù„Ø¹Ù…Ø±" required>
    <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (06xxxxxxx)" required>
    <select id="license" required>
      <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø±Ø®ØµØ©</option>
      <option value="B">B</option>
      <option value="A">A</option>
    </select>
    <button type="submit">Ø£Ø¶Ù Ø§Ù„Ù…ØªØ±Ø´Ø­</button>
  </form>

  <div id="candidatesList">
    <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ±Ø´Ø­ÙŠÙ† Ø¨Ø¹Ø¯.</p>
  </div>

  <div class="edit-form" id="editForm">
    <h3>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø³ Ùˆ ØªÙ‚Ø¯Ù…</h3>

    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
    <input type="date" id="lessonDate">

    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³:</label>
    <input type="text" id="lessonTitle">

    <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù† Ø§Ù„Ø¯Ø±Ø³:</label>
    <input type="text" id="lessonNote">

    <label>Ø§Ù„ØªÙ‚Ø¯Ù… (%):</label>
    <input type="number" id="progressValue" min="0" max="100">

    <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù† Ø§Ù„ØªÙ‚Ø¯Ù…:</label>
    <input type="text" id="progressNote">

    <button id="addLessonProgress">Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ«</button>
    <button id="cancelEdit" style="background:#bbb; color:#000;">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</section>

<!-- POPUP -->
<div class="popup" id="popup">
  <div class="popup-content" id="popupContent"></div>
</div>

<footer>
  Â© 2025 Auto Ã‰cole Ben Cheikh - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
</footer>

<script>
/* === BACKEND LOGIC AS IS === */
const SHEETDB = "https://sheetdb.io/api/v1/o1glqkhxgb58a";

let candidates = [];
let currentId = null;

function logout() {
    localStorage.removeItem("admin_logged");
    window.location.href = "admin-login.html";
}

async function loadData(){
  const r = await fetch(SHEETDB);
  let data = await r.json();

  candidates = data.map(c => ({
    ...c,
    id: Number(c.id),
    lessons: c.lessons ? JSON.parse(c.lessons) : [],
    progress: c.progress ? JSON.parse(c.progress) : [],
  }));

  renderTable();
}
loadData();

document.getElementById("candidateForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  let name = document.querySelector("#name").value.trim();
  let age = document.querySelector("#age").value.trim();
  let phone = document.querySelector("#phone").value.trim();
  let license = document.querySelector("#license").value;

  if(!phone.startsWith("0")) phone = "0" + phone;

  let user = {
    id: Date.now(),
    name, age, phone, license,
    lessons: "[]", progress: "[]"
  };

  await fetch(SHEETDB,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data:user })
  });

  alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ±Ø´Ø­!");
  e.target.reset();
  loadData();
});

function renderTable(){
  const div = document.getElementById("candidatesList");

  if(candidates.length === 0){
    div.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ±Ø´Ø­ÙŠÙ†.</p>";
    return;
  }

  let html = `
    <table>
      <tr>
        <th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±Ø®ØµØ©</th>
        <th>Ø¹Ø±Ø¶</th><th>ØªØ¹Ø¯ÙŠÙ„</th><th>Ø­Ø°Ù</th>
      </tr>
  `;

  candidates.forEach((c,i)=>{
    html += `
      <tr>
        <td>${i+1}</td>
        <td>${c.name}</td>
        <td>${c.phone}</td>
        <td>${c.license}</td>

        <td><button onclick="showDetails(${c.id})">Ø¹Ø±Ø¶</button></td>

        <td><button onclick="startEdit(${c.id})">ØªØ¹Ø¯ÙŠÙ„</button></td>

        <td><button style="background:#c00" onclick="removeUser(${c.id})">Ø­Ø°Ù</button></td>
      </tr>
    `;
  });

  html += "</table>";
  div.innerHTML = html;
}

function startEdit(id){
  currentId = id;
  document.getElementById("editForm").style.display = "block";
}

document.getElementById("addLessonProgress").onclick = async ()=>{
  let c = candidates.find(u => u.id === currentId);
  if(!c) return;

  const date = document.getElementById("lessonDate").value || new Date().toISOString().slice(0,10);
  const title = document.getElementById("lessonTitle").value.trim();
  const note = document.getElementById("lessonNote").value.trim();
  const pv = document.getElementById("progressValue").value;
  const pn = document.getElementById("progressNote").value.trim();

  if(title) c.lessons.push({title, note, date});
  if(pv) c.progress.push({value:pv, note:pn, date});

  await fetch(`${SHEETDB}/id/${c.id}`,{
    method:"PUT",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      data:{
        ...c,
        lessons: JSON.stringify(c.lessons),
        progress: JSON.stringify(c.progress),
      }
    })
  });

  alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
  loadData();
  document.getElementById("editForm").style.display = "none";
};

async function removeUser(id){
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØ±Ø´Ø­ØŸ")) return;

  await fetch(`${SHEETDB}/id/${id}`,{ method:"DELETE" });

  alert("ØªÙ… Ø§Ù„Ø­Ø°Ù!");
  loadData();
}

document.getElementById("cancelEdit").onclick = ()=>{
  document.getElementById("editForm").style.display = "none";
};

function showDetails(id){
  const user = candidates.find(c => c.id === id);
  if(!user) return;

  let html = `<h3>Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ ${user.name}</h3>`;

  html += "<h4>ğŸ“˜ Ø§Ù„Ø¯Ø±ÙˆØ³:</h4>";
  if(user.lessons.length === 0){
    html += "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ø¨Ø¹Ø¯.</p>";
  } else {
    user.lessons.forEach(l=>{
      html += `<div><b>${l.date}</b> - ${l.title} <br> <small>${l.note}</small></div><hr>`;
    });
  }

  html += "<h4>ğŸ“Š Ø§Ù„ØªÙ‚Ø¯Ù…:</h4>";
  if(user.progress.length === 0){
    html += "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø¯Ù… Ø¨Ø¹Ø¯.</p>";
  } else {
    user.progress.forEach(p=>{
      html += `<div><b>${p.date}</b> - ${p.value}% <br> <small>${p.note}</small></div><hr>`;
    });
  }

  html += `<button class="close-btn" onclick="closePopup()">Ø¥ØºÙ„Ø§Ù‚</button>`;

  document.getElementById("popupContent").innerHTML = html;
  document.getElementById("popup").style.display = "flex";
}

function closePopup(){
  document.getElementById("popup").style.display = "none";
}
</script>

</body>
</html>

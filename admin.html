<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة التحكم Admin - Auto École Ben Cheikh</title>

<style>
body { font-family: Arial; direction: rtl; background: #f0f2f5; color:#333; margin:0; padding:0; }
header { background:#004aad; color:white; padding:30px 20px; text-align:center; }
header h1 { margin:0; font-size:36px; }
nav { text-align:center; margin:20px 0; }
nav a { margin:0 10px; text-decoration:none; color:#004aad; font-weight:bold; padding:10px 20px; border:2px solid #004aad; border-radius:8px; transition:0.3s; }
nav a:hover { background:#004aad; color:white; }
section { padding:20px; max-width:900px; margin:auto; background:white; border-radius:10px; box-shadow:0 6px 10px rgba(0,0,0,0.1); }
h2 { text-align:center; color:#004aad; }
form, .edit-form { display:flex; flex-direction:column; gap:12px; margin-top:20px; }
input, select, button { padding:10px; font-size:16px; border-radius:6px; border:1px solid #ccc; }
button { background:#004aad; color:white; cursor:pointer; border:none; transition:0.3s; }
button:hover { background:#003080; }
table { width:100%; border-collapse: collapse; margin-top:15px; }
th, td { border:1px solid #ccc; padding:10px; text-align:center; }
.edit-form { display:none; background:#eef1f5; padding:15px; border-radius:8px; margin-top:20px; }
label { font-weight:bold; }
</style>
</head>

<body>

<header>
  <h1>لوحة التحكم Admin</h1>
  <p>إدارة المترشحين والدروس</p>
</header>

<nav>
  <a href="index.html">الصفحة الرئيسية</a>
</nav>

<section>
  <h2>إضافة مترشح جديد</h2>

  <form id="candidateForm">
    <input type="text" id="name" placeholder="الاسم الكامل" required>
    <input type="number" id="age" placeholder="العمر" required>
    <input type="tel" id="phone" placeholder="رقم الهاتف (06xxxxxxx)" required>
    <select id="license" required>
      <option value="">اختر نوع الرخصة</option>
      <option value="B">B</option>
      <option value="A">A</option>
    </select>
    <button type="submit">أضف المترشح</button>
  </form>

  <div id="candidatesList">
    <p>لا يوجد مترشحين بعد.</p>
  </div>

  <div class="edit-form" id="editForm">
    <h3>إضافة / تعديل درس و تقدم</h3>

    <label>التاريخ:</label>
    <input type="date" id="lessonDate">

    <label>عنوان الدرس:</label>
    <input type="text" id="lessonTitle">

    <label>ملاحظة عن الدرس:</label>
    <input type="text" id="lessonNote">

    <label>التقدم (%):</label>
    <input type="number" id="progressValue" min="0" max="100">

    <label>ملاحظة عن التقدم:</label>
    <input type="text" id="progressNote">

    <button id="addLessonProgress">إضافة / تحديث</button>
    <button id="cancelEdit" style="background:#bbb; color:#000;">إلغاء</button>
  </div>
</section>

<script>
const SHEETDB = "https://sheetdb.io/api/v1/o1glqkhxgb58a";

let candidates = [];
let currentId = null;

// جلب البيانات
async function loadData(){
  const r = await fetch(SHEETDB);
  let data = await r.json();

  candidates = data.map(c => ({
    ...c,
    id: Number(c.id),
    lessons: c.lessons ? JSON.parse(c.lessons) : [],
    progress: c.progress ? JSON.parse(c.progress) : []
  }));

  renderTable();
}
loadData();

// إضافة مترشح
document.getElementById("candidateForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  let name = document.getElementById("name").value.trim();
  let age = document.getElementById("age").value;
  let phone = document.getElementById("phone").value.trim();
  let license = document.getElementById("license").value;

  if(!phone.startsWith("0")) phone = "0" + phone;

  const newUser = {
    id: Date.now(),
    name,
    age,
    phone,
    license,
    lessons: "[]",
    progress: "[]"
  };

  await fetch(SHEETDB,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data:newUser })
  });

  alert("تمت الإضافة بنجاح!");
  loadData();
  e.target.reset();
});

// رسم الجدول
function renderTable(){
  const div = document.getElementById("candidatesList");

  if(candidates.length === 0){
    div.innerHTML = "<p>لا يوجد مترشحين.</p>";
    return;
  }

  let html = `
    <table>
      <tr>
        <th>#</th><th>الاسم</th><th>العمر</th><th>الهاتف</th>
        <th>الرخصة</th><th>تعديل</th><th>حذف</th>
      </tr>
  `;

  candidates.forEach((c,i)=>{
    html += `
      <tr>
        <td>${i+1}</td>
        <td>${c.name}</td>
        <td>${c.age}</td>
        <td>${c.phone}</td>
        <td>${c.license}</td>
        <td><button onclick="startEdit(${c.id})">Edit</button></td>
        <td><button style="background:#c00" onclick="removeUser(${c.id})">حذف</button></td>
      </tr>
    `;
  });

  html += "</table>";
  div.innerHTML = html;
}

// فتح التعديل
function startEdit(id){
  currentId = id;
  document.getElementById("editForm").style.display = "block";
}

// إضافة درس أو تقدم
document.getElementById("addLessonProgress").onclick = async ()=>{

  let c = candidates.find(u => u.id === currentId);
  if(!c) return alert("خطأ!");

  const date = document.getElementById("lessonDate").value || new Date().toISOString().slice(0,10);

  const title = document.getElementById("lessonTitle").value.trim();
  const note  = document.getElementById("lessonNote").value.trim();
  if(title) c.lessons.push({ title, note, date });

  const pv = document.getElementById("progressValue").value;
  const pn = document.getElementById("progressNote").value.trim();
  if(pv) c.progress.push({ value:pv, note:pn, date });

  await fetch(`${SHEETDB}/id/${c.id}`,{
    method:"PUT",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      data:{
        ...c,
        lessons: JSON.stringify(c.lessons),
        progress: JSON.stringify(c.progress)
      }
    })
  });

  alert("تم التحديث!");
  loadData();

  document.getElementById("editForm").style.display = "none";
};

// حذف
async function removeUser(id){
  if(!confirm("هل تريد حذف هذا المترشح؟")) return;

  await fetch(`${SHEETDB}/id/${id}`,{ method:"DELETE" });

  alert("تم الحذف!");
  loadData();
}

document.getElementById("cancelEdit").onclick = ()=>{
  document.getElementById("editForm").style.display = "none";
};
</script>

</body>
</html>

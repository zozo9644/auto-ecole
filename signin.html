<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ±Ø´Ø­ - Auto Ã‰cole Ben Cheikh</title>
<style>
body { font-family: Arial; direction: rtl; background: linear-gradient(135deg, #74ABE2, #5563DE); color: #fff; margin:0; padding:0; }
header { text-align:center; padding:40px 20px; }
header h1 { font-size:36px; margin:0; }
section { background: rgba(255,255,255,0.1); max-width:500px; margin:auto; padding:30px; border-radius:12px; }
input, button { padding:12px; font-size:16px; border-radius:6px; border:none; width:100%; margin-bottom:10px; }
input { border:1px solid #fff; background:rgba(255,255,255,0.2); color:#fff; }
input::placeholder { color:#eee; }
button { background:#004aad; color:white; cursor:pointer; transition:0.3s; }
button:hover { background:#003080; }
.dashboard { margin-top:20px; background: rgba(255,255,255,0.2); padding:15px; border-radius:8px; }
ul { padding-left:20px; }
.error { color: #ffdddd; background: #aa0000; padding:8px; border-radius:5px; margin-bottom:10px; display:none; }
</style>
</head>
<body>

<header>
  <h1>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ±Ø´Ø­</h1>
  <p>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„ØªÙ‚Ø¯Ù…</p>
</header>

<section>
  <div id="errorMsg" class="error"></div>
  <form id="signinForm">
    <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
    <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (06xxxxxxx)" required>
    <button type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </form>

  <div class="dashboard" id="dashboard" style="display:none;">
    <h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="candidateName"></span></h3>
    <p>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø®ØµØ©: <span id="candidateLicense"></span></p>
    <h4>ğŸ“˜ Ø§Ù„Ø¯Ø±ÙˆØ³:</h4>
    <ul id="lessonsList"></ul>
    <h4>ğŸ“Š Ø§Ù„ØªÙ‚Ø¯Ù…:</h4>
    <ul id="progressList"></ul>
  </div>
</section>

<script>
const SHEETDB_API = "https://sheetdb.io/api/v1/o1glqkhxgb58a";
let currentCandidate = null;

// Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ JSON safely
function safeJSON(data){
  if(!data || data.trim() === "") return [];
  try { return JSON.parse(data); } 
  catch(e){ console.warn("JSON Parse Failed:", data); return []; }
}

// ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ±Ø´Ø­
function updateCandidateDashboard(candidate){
  document.getElementById('candidateName').textContent = candidate.name;
  document.getElementById('candidateLicense').textContent = candidate.license;

  const lessons = safeJSON(candidate.lessons);
  const progress = safeJSON(candidate.progress);

  const sortedLessons = lessons.sort((a,b)=>new Date(b.date)-new Date(a.date));
  const sortedProgress = progress.sort((a,b)=>new Date(b.date)-new Date(a.date));

  document.getElementById('lessonsList').innerHTML = sortedLessons.length 
    ? sortedLessons.map(l=>`<li>${l.title} - ${l.note} (${l.date})</li>`).join('')
    : "<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</li>";

  document.getElementById('progressList').innerHTML = sortedProgress.length 
    ? sortedProgress.map(p=>`<li>${p.value}% - ${p.note} (${p.date})</li>`).join('')
    : "<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø¹Ø¯</li>";
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
document.getElementById('signinForm').addEventListener('submit', async function(e){
  e.preventDefault();

  const nameInput = document.getElementById('name').value.trim().toLowerCase().replace(/\s+/g,"");
  let phoneInput = document.getElementById('phone').value.trim().replace(/\D/g,"");
  if(phoneInput.startsWith("0")) phoneInput = phoneInput.slice(1); // normalize Ø¨Ø¯ÙˆÙ† ØµÙØ±

  const errorDiv = document.getElementById('errorMsg');
  errorDiv.style.display = "none";

  try{
    const res = await fetch(SHEETDB_API);
    const allCandidates = await res.json();

    const candidate = allCandidates.find(c => {
      const cName = (c.name || "").toLowerCase().replace(/\s+/g,"");
      let cPhone = String(c.phone || "").replace(/\D/g,"");
      if(cPhone.startsWith("0")) cPhone = cPhone.slice(1);
      return cName === nameInput && cPhone.slice(-9) === phoneInput.slice(-9); // Ø¢Ø®Ø± 9 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
    });

    if(!candidate){
      errorDiv.innerText = "Ø§Ù„Ù…ØªØ±Ø´Ø­ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.";
      errorDiv.style.display = "block";
      return;
    }

    currentCandidate = candidate;
    currentCandidate.lessons = safeJSON(candidate.lessons);
    currentCandidate.progress = safeJSON(candidate.progress);

    document.getElementById('signinForm').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';

    updateCandidateDashboard(currentCandidate);

  }catch(e){
    console.error("Ø®Ø·Ø£ Ù Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", e);
    errorDiv.innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.";
    errorDiv.style.display = "block";
  }
});

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
setInterval(async ()=>{
  if(!currentCandidate) return;
  try{
    const res = await fetch(SHEETDB_API);
    const allCandidates = await res.json();
    const candidate = allCandidates.find(c => Number(c.id) === Number(currentCandidate.id));
    if(candidate){
      candidate.lessons = safeJSON(candidate.lessons);
      candidate.progress = safeJSON(candidate.progress);
      updateCandidateDashboard(candidate);
    }
  }catch(e){ console.error(e); }
},5000);
</script>

</body>
</html>

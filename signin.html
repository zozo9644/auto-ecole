<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسجيل دخول المترشح - Auto École Ben Cheikh</title>
<style>
body {
    font-family: Arial; direction: rtl;
    background: linear-gradient(135deg, #74ABE2, #5563DE);
    color: #fff; margin:0; padding:0; height:100vh;
    display: flex; justify-content: center; align-items: center;
}
section {
    background: rgba(255,255,255,0.1); max-width:500px;
    margin:auto; padding:30px; border-radius:12px;
}
input, button {
    padding:12px; font-size:16px; border-radius:6px; border:none;
}
input {
    border:1px solid #fff; background:rgba(255,255,255,0.2); color:#fff;
}
input::placeholder { color:#eee; }
button {
    background:#004aad; color:white; cursor:pointer; transition:0.3s;
}
button:hover { background:#003080; }
.dashboard {
    margin-top:20px; background: rgba(255,255,255,0.2);
    padding:15px; border-radius:8px;
}
ul { padding-left:20px; }
</style>
</head>
<body>

<section>
  <h2>تسجيل الدخول</h2>
  <form id="signinForm">
    <input type="text" id="name" placeholder="الاسم الكامل" required>
    <input type="tel" id="phone" placeholder="رقم الهاتف (06xxxxxxx)" required>
    <button type="submit">تسجيل الدخول</button>
  </form>

  <div class="dashboard" id="dashboard" style="display:none;">
    <h3>مرحباً، <span id="candidateName"></span></h3>
    <p>نوع الرخصة: <span id="candidateLicense"></span></p>
    <h4>الدروس:</h4>
    <ul id="lessonsList"></ul>
    <h4>التقدم:</h4>
    <ul id="progressList"></ul>
  </div>
</section>

<script>
const SHEETDB_API = "https://sheetdb.io/api/v1/o1glqkhxgb58a";
let currentCandidate = null;

// دالة آمنة لتحويل JSON
function safeJSON(data){
  if(!data || data === "" || data === " ") return [];
  try { return JSON.parse(data); } 
  catch(e){ console.warn("JSON Parse Failed:", data); return []; }
}

// تحديث لوحة المترشح
function updateCandidateDashboard(candidate){
  document.getElementById('candidateName').textContent = candidate.name;
  document.getElementById('candidateLicense').textContent = candidate.license;

  const lessons = safeJSON(candidate.lessons);
  const progress = safeJSON(candidate.progress);

  const sortedLessons = lessons.sort((a,b)=>new Date(b.date)-new Date(a.date));
  const sortedProgress = progress.sort((a,b)=>new Date(b.date)-new Date(a.date));

  document.getElementById('lessonsList').innerHTML = sortedLessons.length 
    ? sortedLessons.map(l=>`<li>${l.title} - ${l.note} (${l.date})</li>`).join('')
    : "<li>لا يوجد دروس مسجلة بعد</li>";

  document.getElementById('progressList').innerHTML = sortedProgress.length 
    ? sortedProgress.map(p=>`<li>${p.value}% - ${p.note} (${p.date})</li>`).join('')
    : "<li>لا يوجد تقدم مسجل بعد</li>";
}

// تسجيل الدخول
document.getElementById('signinForm').addEventListener('submit', async function(e){
  e.preventDefault();
  
  const name = document.getElementById('name').value.trim();
  let phone = document.getElementById('phone').value.trim();
  if(!phone.startsWith("0")) phone = "0"+phone;

  const normalizedName = name.toLowerCase().replace(/\s+/g, "");
  const normalizedPhone = phone.replace(/\s+/g, "");

  try{
    const res = await fetch(SHEETDB_API);
    const allCandidates = await res.json();

    const candidate = allCandidates.find(c => {
      const cName = (c.name || "").toLowerCase().replace(/\s+/g,"");
      const cPhone = String(c.phone || "").replace(/\s+/g,"");
      return cName === normalizedName && cPhone === normalizedPhone;
    });

    if(!candidate){
      alert("المترشح غير موجود! تأكد من الاسم ورقم الهاتف.");
      return;
    }

    currentCandidate = candidate;
    currentCandidate.lessons = safeJSON(candidate.lessons);
    currentCandidate.progress = safeJSON(candidate.progress);

    document.getElementById('signinForm').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';

    updateCandidateDashboard(currentCandidate);

  }catch(e){
    console.error("خطأ ف جلب البيانات", e);
    alert("حدث خطأ أثناء جلب البيانات. حاول لاحقاً.");
  }
});

// متابعة التحديثات كل 5 ثواني
setInterval(async ()=>{
  if(!currentCandidate) return;
  try{
    const res = await fetch(SHEETDB_API);
    const allCandidates = await res.json();

    const candidate = allCandidates.find(c => Number(c.id) === Number(currentCandidate.id));
    if(candidate){
      candidate.lessons = safeJSON(candidate.lessons);
      candidate.progress = safeJSON(candidate.progress);
      updateCandidateDashboard(candidate);
    }
  }catch(e){ console.error(e); }
},5000);
</script>

</body>
</html>
